<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Score Control</title>
  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;margin:14px;background:#f6f7fb;color:#111;}
    .box{background:#fff;border:1px solid #e6e7ee;border-radius:16px;padding:14px;margin-bottom:12px;box-shadow:0 10px 26px rgba(0,0,0,.06);}
    h2{margin:0 0 10px 0}
    label{display:block;font-weight:900;margin:10px 0 6px}
    input[type="text"], input[type="url"], input[type="date"]{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid #d8dbe6;font-size:16px; outline:none;
    }
    input:focus{border-color:#7a86ff;box-shadow:0 0 0 4px rgba(122,134,255,.18);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 260px}
    .btn{padding:12px 14px;border-radius:14px;border:0;background:#111;color:#fff;font-weight:1000;font-size:16px;cursor:pointer;}
    .btn.secondary{background:#4a4f64}
    .btn.danger{background:#b00020}
    .btn.ghost{background:#eef0f7;color:#111}
    .btn.big{font-size:22px;padding:14px 18px;border-radius:16px}
    .score{font-size:34px;font-weight:1100;min-width:54px;text-align:center}
    .muted{color:#5a5f75;font-size:14px}
    .toggle{display:flex;gap:10px;align-items:center;margin-top:8px}
    input[type="color"]{width:56px;height:44px;border:0;background:transparent;padding:0}
    .pill{display:inline-flex;align-items:center;gap:10px;background:#111;color:#fff;border-radius:999px;padding:8px 12px;font-weight:1000;font-size:13px;}
    .pill.ok{background:#0f7b3e}
    .pill.bad{background:#b00020}
    .sep{height:1px;background:#eceef6;margin:12px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .small{font-size:13px}
    .teamButtons{display:flex;flex-wrap:wrap;gap:10px}
    .teamButtons .btn{white-space:nowrap}
  </style>
</head>
<body>

<h2>Пульт управления табло</h2>

<div class="box">
  <div class="muted">1) Вставь URL Google Apps Script (оканчивается на <b>/exec</b>) и нажми «Сохранить».</div>
  <label>Apps Script URL</label>
  <input id="api" type="url" placeholder="https://script.google.com/macros/s/.../exec">
  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="saveApi()">Сохранить</button>
    <span id="apiStatus" class="pill bad">не настроено</span>
    <button class="btn ghost" onclick="pull()">Прочитать состояние</button>
    <span class="pill secondary" id="nowTz">—</span>
  </div>
  <div class="muted small" style="margin-top:8px">
    Справа показывается <b>текущее время в выбранном часовом поясе</b> (для контроля).
  </div>
</div>

<div class="box">
  <label>Мероприятие (турнир)</label>
  <input id="title" type="text" placeholder="Первенство Московской области">
  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="saveTitle()">Сохранить</button>

    <button class="btn ghost" onclick="quickTitle('Первенство Московской области')">Первенство МО</button>
    <button class="btn ghost" onclick="quickTitle('Детская лига')">Детская лига</button>
    <button class="btn ghost" onclick="quickTitle('Кубок России')">Кубок России</button>
    <button class="btn ghost" onclick="quickTitle('Чемпионат России')">Чемпионат России</button>
    <button class="btn ghost" onclick="quickTitle('Кубок Патриарха')">Кубок Патриарха</button>
    <button class="btn ghost" onclick="quickTitle('Турнир памяти')">Турнир памяти</button>

    <button class="btn ghost" onclick="quickTitle('Товарищеская встреча')">Товарищеская</button>
    <button class="btn ghost" onclick="quickTitle('Игровая тренировка')">Игровая тренировка</button>
  </div>
</div>

<div class="box grid2">
  <div>
    <label>Сезон (бейдж сверху рядом с LIVE)</label>
    <input id="season" type="text" placeholder="2025–2026">
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="saveSeason()">Сохранить сезон</button>
      <button class="btn ghost" onclick="setSeason('2025–2026')">2025–2026</button>
      <button class="btn ghost" onclick="setSeason('2026–2027')">2026–2027</button>
      <button class="btn secondary" onclick="setSeason('')">Скрыть</button>
    </div>
  </div>

  <div>
    <label>Часовой пояс (для “реального местного времени”)</label>
    <input id="timeZone" type="text" value="Europe/Moscow">
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="saveTimeZone()">Сохранить TZ</button>
      <button class="btn ghost" onclick="setTZ('Europe/Moscow')">Москва</button>
      <button class="btn ghost" onclick="setTZ('Asia/Yekaterinburg')">Екатеринбург</button>
      <button class="btn ghost" onclick="setTZ('Asia/Krasnoyarsk')">Красноярск</button>
      <button class="btn ghost" onclick="setTZ('Asia/Irkutsk')">Иркутск</button>
      <button class="btn ghost" onclick="setTZ('Europe/Kirov')">Киров</button>
    </div>
    <div class="muted small" style="margin-top:8px">
      Если стадион в другом регионе — выбирай TZ и в оверлее справа снизу будет правильное местное время.
    </div>
  </div>
</div>

<div class="box grid2">
  <div>
    <label>Дата проведения (внизу справа)</label>
    <input id="eventDate" type="date">
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="saveEventDate()">Сохранить дату</button>
      <button class="btn ghost" onclick="setToday()">Сегодня</button>
      <button class="btn secondary" onclick="clearEventDate()">Скрыть дату</button>
    </div>

    <div class="toggle" style="margin-top:10px">
      <input id="showDateTime" type="checkbox" checked>
      <label style="margin:0;font-weight:900">Показывать дату + местное время</label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="saveShowDateTime()">Сохранить</button>
    </div>
  </div>

  <div>
    <label>Твой логотип (в левом нижнем углу)</label>
    <input id="brandLogo" type="url" placeholder="https://.../my_vk_group_logo.png">
    <div class="toggle" style="margin-top:10px">
      <input id="showBrandLogo" type="checkbox" checked>
      <label style="margin:0;font-weight:900">Показывать логотип</label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="saveBrand()">Сохранить логотип</button>
      <button class="btn ghost" onclick="setBrandVK()">VK группа</button>
      <button class="btn secondary" onclick="hideBrand()">Скрыть</button>
    </div>
    <div class="muted small" style="margin-top:8px">Лучше PNG 512×512 с прозрачным фоном.</div>
  </div>
</div>

<div class="box">
  <div class="row">
    <button class="btn" onclick="setLive(true)">LIVE ON</button>
    <button class="btn secondary" onclick="setLive(false)">LIVE OFF</button>
    <button class="btn danger" onclick="setBreak()">ПЕРЕРЫВ</button>
    <button class="btn secondary" onclick="setStatus('ТАЙМ-АУТ')">ТАЙМ-АУТ</button>
    <button class="btn secondary" onclick="setStatus('МАТЧ ОКОНЧЕН')">МАТЧ ОКОНЧЕН</button>
    <button class="btn ghost" onclick="clearStatus()">Снять статус</button>

    <button class="btn danger" onclick="swapTeams()">ПОМЕНЯТЬ КОМАНДЫ МЕСТАМИ</button>
  </div>
</div>

<div class="box">
  <div class="grid2">
    <div>
      <div class="row">
        <div class="grow">
          <label>Команда A</label>
          <input id="nameA" type="text" placeholder="Команда A">
        </div>
        <div>
          <label>Цвет A</label>
          <input id="colorA" type="color" value="#1e88e5">
        </div>
      </div>
      <label>Логотип A (URL PNG/SVG)</label>
      <input id="logoA" type="url" placeholder="https://.../logoA.png">
    </div>

    <div>
      <div class="row">
        <div class="grow">
          <label>Команда B</label>
          <input id="nameB" type="text" placeholder="Команда B">
        </div>
        <div>
          <label>Цвет B</label>
          <input id="colorB" type="color" value="#e53935">
        </div>
      </div>
      <label>Логотип B (URL PNG/SVG)</label>
      <input id="logoB" type="url" placeholder="https://.../logoB.png">
    </div>
  </div>

  <div class="sep"></div>

  <div class="row">
    <button class="btn" onclick="saveTeams()">СОХРАНИТЬ КОМАНДЫ (имя/цвет/лого)</button>
    <button class="btn ghost" onclick="pull()">Проверить (прочитать)</button>
  </div>
</div>

<div class="box">
  <label>Готовые кнопки команд (подставляют имя+логотип+цвет и сохраняют)</label>
  <div class="teamButtons">
    <!-- Нажимаешь: Команда → A или → B -->
    <button class="btn ghost" onclick="applyPreset('A','Зоркий девочки')">Зоркий девочки → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий девочки')">Зоркий девочки → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий 2015')">Зоркий 2015 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий 2015')">Зоркий 2015 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий 2014')">Зоркий 2014 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий 2014')">Зоркий 2014 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий 2013')">Зоркий 2013 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий 2013')">Зоркий 2013 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий 2012')">Зоркий 2012 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий 2012')">Зоркий 2012 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий 2011')">Зоркий 2011 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий 2011')">Зоркий 2011 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий 2010')">Зоркий 2010 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий 2010')">Зоркий 2010 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий 2009')">Зоркий 2009 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий 2009')">Зоркий 2009 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зоркий Красногорск')">Зоркий КГ → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зоркий Красногорск')">Зоркий КГ → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Зенит Иркутск')">Зенит → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Зенит Иркутск')">Зенит → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Всеволожск')">Всеволожск → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Всеволожск')">Всеволожск → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Сб. Ленинградской области')">Сб. Лен обл → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Сб. Ленинградской области')">Сб. Лен обл → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Водник Архангельск')">Водник → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Водник Архангельск')">Водник → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Вымпел Королёв')">Вымпел → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Вымпел Королёв')">Вымпел → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Сб. Свердловской области')">Сб. Свердл обл → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Сб. Свердловской области')">Сб. Свердл обл → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Строитель Сыктывкар')">Строитель → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Строитель Сыктывкар')">Строитель → B</button>

    <button class="btn ghost" onclick="applyPreset('A','СКА Хабаровск')">СКА → A</button>
    <button class="btn ghost" onclick="applyPreset('B','СКА Хабаровск')">СКА → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Сибскана Иркутск')">Сибскана → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Сибскана Иркутск')">Сибскана → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Сибскана-2 Иркутск')">Сибскана-2 → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Сибскана-2 Иркутск')">Сибскана-2 → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Русич Ликино-Дулево')">Русич → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Русич Ликино-Дулево')">Русич → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Родина Киров')">Родина → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Родина Киров')">Родина → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Обухово')">Обухово → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Обухово')">Обухово → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Сб. Мурманской области')">Сб. Мурманск → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Сб. Мурманской области')">Сб. Мурманск → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Сб. Московской области')">Сб. МО → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Сб. Московской области')">Сб. МО → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Кузбасс Кемерово')">Кузбасс → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Кузбасс Кемерово')">Кузбасс → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Енисей Красноярск')">Енисей → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Енисей Красноярск')">Енисей → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Динамо Москва')">Динамо → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Динамо Москва')">Динамо → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Балашиха')">Балашиха → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Балашиха')">Балашиха → B</button>

    <button class="btn ghost" onclick="applyPreset('A','Филимоново')">Филимоново → A</button>
    <button class="btn ghost" onclick="applyPreset('B','Филимоново')">Филимоново → B</button>
  </div>

  <div class="muted small" style="margin-top:10px">
    Лого берутся из <b>/assets/&lt;имя_файла&gt;.png</b>. Если у тебя расширение другое — поменяй в JS константу <b>LOGO_EXT</b>.
  </div>
</div>

<div class="box">
  <div class="row">
    <button class="btn big" onclick="score('A',-1)">A −</button>
    <div class="score" id="scoreA">0</div>
    <button class="btn big" onclick="score('A',+1)">A +</button>

    <button class="btn big" onclick="score('B',-1)">B −</button>
    <div class="score" id="scoreB">0</div>
    <button class="btn big" onclick="score('B',+1)">B +</button>

    <button class="btn danger" onclick="resetScores()">СБРОС СЧЁТА 0:0</button>
  </div>
  <div class="muted" style="margin-top:8px">Кнопки счёта меняют только счёт (не затирают названия).</div>
</div>

<div class="box">
  <div class="row">
    <div class="grow">
      <label>Тайм (текст)</label>
      <input id="periodLabel" type="text" placeholder="1 тайм / 2 тайм / Перерыв / Доп. время">
    </div>
    <div class="toggle">
      <input id="showPeriod" type="checkbox" checked>
      <label style="margin:0;font-weight:900">Показывать</label>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn ghost" onclick="setPeriod('1 тайм')">1 тайм</button>
    <button class="btn ghost" onclick="setPeriod('2 тайм')">2 тайм</button>
    <button class="btn ghost" onclick="setPeriod('Доп. время')">Доп.</button>
    <button class="btn ghost" onclick="setPeriod('ПЕРЕРЫВ')">Перерыв</button>
    <button class="btn secondary" onclick="savePeriod()">Сохранить</button>
    <button class="btn secondary" onclick="hidePeriod()">Скрыть</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <div class="toggle">
      <input id="showClock" type="checkbox">
      <label style="margin:0;font-weight:900">Показывать время матча</label>
    </div>
    <span class="muted" id="clockInfo">—</span>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="clockStart()">Старт</button>
    <button class="btn secondary" onclick="clockStop()">Пауза</button>
    <button class="btn danger" onclick="clockReset()">Сброс</button>
    <button class="btn ghost" onclick="setShowClock(false)">Скрыть</button>
    <button class="btn ghost" onclick="setShowClock(true)">Показать</button>
  </div>
</div>

<script>
  let API = "";
  let state = null;

  // Где лежат логотипы: /assets/<file>.png
  const LOGO_EXT = ".png";
  const LOGO_BASE = "https://endorfin61-gif.github.io/scoreboard/assets/";
  const DEFAULT_BRAND_LOGO = LOGO_BASE + "vklogogroup" + LOGO_EXT;

  const TEAM_PRESETS = {
    "Зоркий девочки":               { name:"Зоркий девочки",                 file:"zorkiy_dev",   color:"#1e88e5" },
    "Зоркий 2015":                  { name:"Зоркий 2015",                    file:"zorkiy_2015",  color:"#1e88e5" },
    "Зоркий 2014":                  { name:"Зоркий 2014",                    file:"zorkiy_2014",  color:"#1e88e5" },
    "Зоркий 2013":                  { name:"Зоркий 2013",                    file:"zorkiy_2013",  color:"#1e88e5" },
    "Зоркий 2012":                  { name:"Зоркий 2012",                    file:"zorkiy_2012",  color:"#1e88e5" },
    "Зоркий 2011":                  { name:"Зоркий 2011",                    file:"zorkiy_2011",  color:"#1e88e5" },
    "Зоркий 2010":                  { name:"Зоркий 2010",                    file:"zorkiy_2010",  color:"#1e88e5" },
    "Зоркий 2009":                  { name:"Зоркий 2009",                    file:"zorkiy_2009",  color:"#1e88e5" },
    "Зоркий Красногорск":           { name:"Зоркий Красногорск",             file:"zorkiy",       color:"#1e88e5" }, /* поменяй file если нужно */

    "Зенит Иркутск":                { name:"Зенит Иркутск",                  file:"zenit",        color:"#1e88e5" },
    "Всеволожск":                   { name:"Всеволожск",                     file:"vsevolozhsk",  color:"#4a4f64" },
    "Сб. Ленинградской области":    { name:"Сб. Ленинградской области",      file:"sb_len_obl",   color:"#4a4f64" },
    "Водник Архангельск":           { name:"Водник Архангельск",             file:"vodnik",       color:"#f4b400" },
    "Вымпел Королёв":               { name:"Вымпел Королёв",                 file:"vimpel",       color:"#4a4f64" },
    "Сб. Свердловской области":     { name:"Сб. Свердловской области",       file:"svrdlobl",     color:"#4a4f64" },
    "Строитель Сыктывкар":          { name:"Строитель Сыктывкар",            file:"stroitel",     color:"#4a4f64" },
    "СКА Хабаровск":                { name:"СКА Хабаровск",                  file:"ska",          color:"#b00020" },
    "Сибскана Иркутск":             { name:"Сибскана Иркутск",               file:"sibskana",     color:"#1e88e5" },
    "Сибскана-2 Иркутск":           { name:"Сибскана-2 Иркутск",             file:"sibskana2",    color:"#1e88e5" },
    "Русич Ликино-Дулево":          { name:"Русич Ликино-Дулево",            file:"rusich",       color:"#4a4f64" },
    "Родина Киров":                 { name:"Родина Киров",                   file:"rodina",       color:"#4a4f64" },
    "Обухово":                      { name:"Обухово",                        file:"obukhovo",     color:"#4a4f64" },
    "Сб. Мурманской области":       { name:"Сб. Мурманской области",         file:"murmanskobl",  color:"#4a4f64" },
    "Сб. Московской области":       { name:"Сб. Московской области",         file:"mosobl",       color:"#4a4f64" },
    "Кузбасс Кемерово":             { name:"Кузбасс Кемерово",               file:"kuzbass",      color:"#4a4f64" },
    "Енисей Красноярск":            { name:"Енисей Красноярск",              file:"enisey",       color:"#b00020" },
    "Динамо Москва":                { name:"Динамо Москва",                  file:"dinamo",       color:"#1e88e5" },
    "Балашиха":                     { name:"Балашиха",                       file:"Balashikha",   color:"#4a4f64" },
    "Филимоново":                   { name:"Филимоново",                     file:"filimonovo",   color:"#4a4f64" }
  };

  function presetLogoUrl(file){
    return (file && file.trim()) ? (LOGO_BASE + file.trim() + LOGO_EXT) : "";
  }

  function applyPreset(teamLetter, presetName){
    const p = TEAM_PRESETS[presetName];
    if(!p) return alert("Не найден пресет: " + presetName);

    document.getElementById("name"+teamLetter).value = p.name;
    document.getElementById("color"+teamLetter).value = p.color || (teamLetter === "A" ? "#1e88e5" : "#e53935");
    document.getElementById("logo"+teamLetter).value = presetLogoUrl(p.file);

    saveTeams();
  }

  function getApi(){ return localStorage.getItem("SCORE_API") || ""; }

  function setApiStatus(ok){
    const el = document.getElementById("apiStatus");
    if(ok){ el.textContent = "готово"; el.classList.remove("bad"); el.classList.add("ok"); }
    else { el.textContent = "не настроено"; el.classList.remove("ok"); el.classList.add("bad"); }
  }

  function saveApi(){
    const v = document.getElementById("api").value.trim();
    if(!v) return alert("Вставь URL Apps Script (/exec).");
    localStorage.setItem("SCORE_API", v);
    API = v;
    setApiStatus(true);
    pull();
    alert("Сохранено.");
  }

  function sendPatch(patch){
    API = API || getApi();
    if(!API) return alert("Сначала вставь и сохрани Apps Script URL.");
    const payload = encodeURIComponent(JSON.stringify(patch));
    const url = API + "?action=set&payload=" + payload + "&t=" + Date.now();
    const img = new Image();
    img.src = url;
  }

  async function pull(){
    API = API || getApi();
    if(!API) { setApiStatus(false); return; }
    document.getElementById("api").value = API;
    setApiStatus(true);
    try{
      const r = await fetch(API + "?t=" + Date.now(), { cache:"no-store" });
      state = await r.json();
      render();
    }catch(e){}
  }

  function safeSetValue(id, value){
    const el = document.getElementById(id);
    if(!el) return;
    if(document.activeElement === el) return;
    el.value = value ?? "";
  }
  function safeSetChecked(id, value){
    const el = document.getElementById(id);
    if(!el) return;
    if(document.activeElement === el) return;
    el.checked = !!value;
  }

  function msToMMSS(ms){
    ms = Math.max(0, ms|0);
    const t = Math.floor(ms/1000);
    const m = String(Math.floor(t/60)).padStart(2,'0');
    const s = String(t%60).padStart(2,'0');
    return `${m}:${s}`;
  }

  function render(){
    if(!state) return;

    safeSetValue("title", state.title || "");
    safeSetValue("season", state.season || "");
    safeSetValue("timeZone", state.timeZone || "Europe/Moscow");

    // teams
    safeSetValue("nameA", state.teamA?.name || "");
    safeSetValue("nameB", state.teamB?.name || "");
    safeSetValue("logoA", state.teamA?.logo || "");
    safeSetValue("logoB", state.teamB?.logo || "");

    const colorA = document.getElementById("colorA");
    if(colorA && document.activeElement !== colorA) colorA.value = state.teamA?.color || "#1e88e5";
    const colorB = document.getElementById("colorB");
    if(colorB && document.activeElement !== colorB) colorB.value = state.teamB?.color || "#e53935";

    // scores
    document.getElementById("scoreA").textContent = state.teamA?.score ?? 0;
    document.getElementById("scoreB").textContent = state.teamB?.score ?? 0;

    // period
    safeSetChecked("showPeriod", !!state.showPeriod);
    safeSetValue("periodLabel", state.periodLabel || "");

    // clock
    safeSetChecked("showClock", !!state.showClock);
    const c = state.clock || {};
    document.getElementById("clockInfo").textContent =
      (c.running ? "⏱️ идёт" : "⏸️ пауза") + " | " + msToMMSS(c.baseMs||0);

    // date/time + brand
    safeSetChecked("showDateTime", !!state.showDateTime);
    safeSetValue("eventDate", state.eventDate || "");
    safeSetChecked("showBrandLogo", !!state.showBrandLogo);
    safeSetValue("brandLogo", state.brandLogo || "");

    // update pill time (local time in selected tz)
    updateNowTz();
  }

  // ---- live clock in control (selected tz)
  function updateNowTz(){
    const tz = (document.getElementById("timeZone").value || "Europe/Moscow").trim();
    try{
      const now = new Date();
      const timeText = new Intl.DateTimeFormat("ru-RU", {
        timeZone: tz,
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      }).format(now);
      document.getElementById("nowTz").textContent = tz + " • " + timeText;
    }catch(e){
      document.getElementById("nowTz").textContent = tz;
    }
  }
  setInterval(updateNowTz, 500);

  // ---------- Tournament / Title ----------
  function saveTitle(){ sendPatch({ title: document.getElementById("title").value.trim() }); setTimeout(pull, 450); }
  function quickTitle(t){ document.getElementById("title").value = t; saveTitle(); }

  // ---------- Season / TZ ----------
  function saveSeason(){ sendPatch({ season: document.getElementById("season").value.trim() }); setTimeout(pull, 450); }
  function setSeason(s){ document.getElementById("season").value = s; saveSeason(); }

  function saveTimeZone(){
    const tz = document.getElementById("timeZone").value.trim() || "Europe/Moscow";
    sendPatch({ timeZone: tz });
    setTimeout(pull, 450);
  }
  function setTZ(tz){ document.getElementById("timeZone").value = tz; saveTimeZone(); }

  // ---------- Date/Time ----------
  function saveEventDate(){ sendPatch({ eventDate: document.getElementById("eventDate").value }); setTimeout(pull, 450); }
  function clearEventDate(){ document.getElementById("eventDate").value = ""; sendPatch({ eventDate: "" }); setTimeout(pull, 450); }
  function saveShowDateTime(){ sendPatch({ showDateTime: document.getElementById("showDateTime").checked }); setTimeout(pull, 450); }
  function setToday(){
    const d = new Date();
    const iso = d.toISOString().slice(0,10);
    document.getElementById("eventDate").value = iso;
    sendPatch({ eventDate: iso, showDateTime: true });
    setTimeout(pull, 450);
  }

  // ---------- Brand ----------
  function setBrandVK(){
    document.getElementById("brandLogo").value = DEFAULT_BRAND_LOGO;
    document.getElementById("showBrandLogo").checked = true;
    saveBrand();
  }

  function saveBrand(){
    sendPatch({
      brandLogo: document.getElementById("brandLogo").value.trim(),
      showBrandLogo: document.getElementById("showBrandLogo").checked
    });
    setTimeout(pull, 450);
  }
  function hideBrand(){ document.getElementById("showBrandLogo").checked = false; sendPatch({ showBrandLogo:false }); setTimeout(pull, 450); }

  // ---------- Teams ----------
  function saveTeams(){
    const aName = document.getElementById("nameA").value.trim();
    const bName = document.getElementById("nameB").value.trim();

    localStorage.setItem("TEAM_A_NAME", aName);
    localStorage.setItem("TEAM_B_NAME", bName);

    sendPatch({
      teamA: { name: aName, color: document.getElementById("colorA").value, logo: document.getElementById("logoA").value.trim() },
      teamB: { name: bName, color: document.getElementById("colorB").value, logo: document.getElementById("logoB").value.trim() }
    });
    setTimeout(pull, 450);
  }

  function swapTeams(){
    if(!state) return pull();
    const nextA = state.teamB || {};
    const nextB = state.teamA || {};
    sendPatch({ teamA: nextA, teamB: nextB });
    setTimeout(pull, 450);
  }

  // ---------- Score ----------
  function score(team, delta){
    if(!state) return pull();
    const key = team === "A" ? "teamA" : "teamB";
    const cur = state[key]?.score ?? 0;
    const next = Math.max(0, cur + delta);
    const patch = {}; patch[key] = { score: next };
    sendPatch(patch);
    state[key].score = next;
    render();
  }

  function resetScores(){
    sendPatch({ teamA:{ score:0 }, teamB:{ score:0 } });
    setTimeout(pull, 450);
  }

  // ---------- LIVE / Status / Break ----------
  function setLive(v){ sendPatch({ live: !!v, status: v ? "LIVE" : "" }); setTimeout(pull, 450); }
  function setStatus(t){ sendPatch({ status: (t||"").trim(), live:true }); setTimeout(pull, 450); }
  function clearStatus(){ sendPatch({ status: "" }); setTimeout(pull, 450); }

  function setBreak(){
    if(!state) return pull();
    const c = state.clock || {};
    const patch = { status: "ПЕРЕРЫВ", live: true, showClock: false, showPeriod: true, periodLabel: "ПЕРЕРЫВ" };
    if(c.running){
      const base = (c.baseMs||0) + (Date.now() - (c.startTs||Date.now()));
      patch.clock = { running:false, startTs:null, baseMs: base };
    }
    sendPatch(patch);
    setTimeout(pull, 450);
  }

  // ---------- Period ----------
  function setPeriod(text){
    document.getElementById("periodLabel").value = text;
    document.getElementById("showPeriod").checked = true;
    savePeriod();
  }
  function savePeriod(){
    sendPatch({ showPeriod: document.getElementById("showPeriod").checked, periodLabel: document.getElementById("periodLabel").value.trim() });
    setTimeout(pull, 450);
  }
  function hidePeriod(){ document.getElementById("showPeriod").checked = false; savePeriod(); }

  // ---------- Clock ----------
  function setShowClock(v){ document.getElementById("showClock").checked = !!v; sendPatch({ showClock: !!v }); setTimeout(pull, 450); }

  function clockStart(){
    if(!state) return pull();
    const c = state.clock || {};
    if(c.running) return;
    sendPatch({ showClock:true, clock:{ running:true, startTs: Date.now() }, status:"LIVE", live:true });
    setTimeout(pull, 450);
  }

  function clockStop(){
    if(!state) return pull();
    const c = state.clock || {};
    if(!c.running) return;
    const base = (c.baseMs||0) + (Date.now() - (c.startTs||Date.now()));
    sendPatch({ clock:{ running:false, startTs:null, baseMs: base } });
    setTimeout(pull, 450);
  }

  function clockReset(){
    sendPatch({ clock:{ running:false, startTs:null, baseMs: 0 } });
    setTimeout(pull, 450);
  }

  // init
  (function init(){
    API = getApi();
    document.getElementById("api").value = API;
    setApiStatus(!!API);

    const a = localStorage.getItem("TEAM_A_NAME");
    const b = localStorage.getItem("TEAM_B_NAME");
    if(a) document.getElementById("nameA").value = a;
    if(b) document.getElementById("nameB").value = b;

    updateNowTz();
    pull();
  })();
</script>

</body>
</html>