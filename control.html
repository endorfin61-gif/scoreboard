<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Score Control</title>
  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;margin:14px;background:#f6f7fb;color:#111;}
    .box{background:#fff;border:1px solid #e6e7ee;border-radius:16px;padding:14px;margin-bottom:12px;box-shadow:0 10px 26px rgba(0,0,0,.06);}
    h2{margin:0 0 10px 0}
    label{display:block;font-weight:900;margin:10px 0 6px}
    input[type="text"], input[type="url"]{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid #d8dbe6;font-size:16px; outline:none;
    }
    input:focus{border-color:#7a86ff;box-shadow:0 0 0 4px rgba(122,134,255,.18);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 260px}
    .btn{padding:12px 14px;border-radius:14px;border:0;background:#111;color:#fff;font-weight:1000;font-size:16px;cursor:pointer;}
    .btn.secondary{background:#4a4f64}
    .btn.danger{background:#b00020}
    .btn.ghost{background:#eef0f7;color:#111}
    .btn.big{font-size:22px;padding:14px 18px;border-radius:16px}
    .score{font-size:34px;font-weight:1100;min-width:54px;text-align:center}
    .muted{color:#5a5f75;font-size:14px}
    .toggle{display:flex;gap:10px;align-items:center;margin-top:8px}
    input[type="color"]{width:56px;height:44px;border:0;background:transparent;padding:0}
    .pill{display:inline-flex;align-items:center;gap:10px;background:#111;color:#fff;border-radius:999px;padding:8px 12px;font-weight:1000;font-size:13px;}
    .pill.ok{background:#0f7b3e}
    .pill.bad{background:#b00020}
    .sep{height:1px;background:#eceef6;margin:12px 0}
  </style>
</head>
<body>

<h2>Пульт управления табло</h2>

<div class="box">
  <div class="muted">1) Вставь URL Google Apps Script (оканчивается на <b>/exec</b>) и нажми «Сохранить».</div>
  <label>Apps Script URL</label>
  <input id="api" type="url" placeholder="https://script.google.com/macros/s/.../exec">
  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="saveApi()">Сохранить</button>
    <span id="apiStatus" class="pill bad">не настроено</span>
    <button class="btn ghost" onclick="pull()">Прочитать состояние</button>
  </div>
</div>

<div class="box">
  <label>Заголовок (турнир)</label>
  <input id="title" type="text" placeholder="Чемпионат Московской области">
  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="saveTitle()">Сохранить заголовок</button>
    <button class="btn ghost" onclick="quickTitle('Первенство России')">Первенство России</button>
    <button class="btn ghost" onclick="quickTitle('Чемпионат МО')">Чемпионат МО</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <button class="btn" onclick="setLive(true)">LIVE ON</button>
    <button class="btn secondary" onclick="setLive(false)">LIVE OFF</button>
    <button class="btn danger" onclick="setBreak()">ПЕРЕРЫВ</button>
    <button class="btn secondary" onclick="clearStatus()">Снять статус</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <div class="grow">
      <label>Команда A</label>
      <input id="nameA" type="text" placeholder="Команда A">
    </div>
    <div>
      <label>Цвет A</label>
      <input id="colorA" type="color" value="#1e88e5">
    </div>
  </div>
  <label>Логотип A (URL PNG/SVG)</label>
  <input id="logoA" type="url" placeholder="https://.../logoA.png">

  <div class="sep"></div>

  <div class="row">
    <button class="btn big" onclick="score('A',-1)">A −</button>
    <div class="score" id="scoreA">0</div>
    <button class="btn big" onclick="score('A',+1)">A +</button>
    <button class="btn ghost" onclick="setScore('A',0)">Сброс A</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <div class="grow">
      <label>Команда B</label>
      <input id="nameB" type="text" placeholder="Команда B">
    </div>
    <div>
      <label>Цвет B</label>
      <input id="colorB" type="color" value="#e53935">
    </div>
  </div>
  <label>Логотип B (URL PNG/SVG)</label>
  <input id="logoB" type="url" placeholder="https://.../logoB.png">

  <div class="sep"></div>

  <div class="row">
    <button class="btn big" onclick="score('B',-1)">B −</button>
    <div class="score" id="scoreB">0</div>
    <button class="btn big" onclick="score('B',+1)">B +</button>
    <button class="btn ghost" onclick="setScore('B',0)">Сброс B</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <button class="btn" onclick="saveTeams()">СОХРАНИТЬ КОМАНДЫ (имена/цвета/логотипы)</button>
    <button class="btn secondary" onclick="pull()">Проверить (прочитать)</button>
  </div>
  <div class="muted" style="margin-top:8px">
    Сначала меняешь имена → жмёшь “СОХРАНИТЬ КОМАНДЫ”. Потом уже счёт.
  </div>
</div>

<div class="box">
  <div class="row">
    <div class="grow">
      <label>Тайм (текст)</label>
      <input id="periodLabel" type="text" placeholder="1 тайм / 2 тайм / Перерыв / Доп. время">
    </div>
    <div class="toggle">
      <input id="showPeriod" type="checkbox">
      <label style="margin:0;font-weight:900">Показывать</label>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn ghost" onclick="setPeriod('1 тайм')">1 тайм</button>
    <button class="btn ghost" onclick="setPeriod('2 тайм')">2 тайм</button>
    <button class="btn ghost" onclick="setPeriod('Доп. время')">Доп.</button>
    <button class="btn secondary" onclick="savePeriod()">Сохранить тайм</button>
  </div>
</div>

<div class="box">
  <div class="row">
    <div class="toggle">
      <input id="showClock" type="checkbox">
      <label style="margin:0;font-weight:900">Показывать время</label>
    </div>
    <span class="muted" id="clockInfo">—</span>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="clockStart()">Старт</button>
    <button class="btn secondary" onclick="clockStop()">Пауза</button>
    <button class="btn danger" onclick="clockReset()">Сброс</button>
    <button class="btn ghost" onclick="setShowClock(false)">Скрыть</button>
    <button class="btn ghost" onclick="setShowClock(true)">Показать</button>
  </div>
</div>

<script>
  let API = "";
  let state = null;

  function getApi(){
    return localStorage.getItem("SCORE_API") || "";
  }

  function setApiStatus(ok){
    const el = document.getElementById("apiStatus");
    if(ok){
      el.textContent = "готово";
      el.classList.remove("bad");
      el.classList.add("ok");
    }else{
      el.textContent = "не настроено";
      el.classList.remove("ok");
      el.classList.add("bad");
    }
  }

  function saveApi(){
    const v = document.getElementById("api").value.trim();
    if(!v) return alert("Вставь URL Apps Script (/exec).");
    localStorage.setItem("SCORE_API", v);
    API = v;
    setApiStatus(true);
    pull();
    alert("Сохранено.");
  }

  // Отправка патча без CORS: GET ?action=set&payload=...
  function sendPatch(patch){
    API = API || getApi();
    if(!API) return alert("Сначала вставь и сохрани Apps Script URL.");
    const payload = encodeURIComponent(JSON.stringify(patch));
    const url = API + "?action=set&payload=" + payload + "&t=" + Date.now();
    const img = new Image();
    img.src = url;
  }

  async function pull(){
    API = API || getApi();
    if(!API) { setApiStatus(false); return; }
    document.getElementById("api").value = API;
    setApiStatus(true);

    try{
      const r = await fetch(API + "?t=" + Date.now(), { cache:"no-store" });
      state = await r.json();
      render();
    }catch(e){
      // если fetch капризничает — не страшно, управление всё равно работает
    }
  }

  function safeSetValue(id, value){
    const el = document.getElementById(id);
    if(!el) return;
    // не перетираем поле, когда ты в нём печатаешь
    if(document.activeElement === el) return;
    el.value = value ?? "";
  }
  function safeSetChecked(id, value){
    const el = document.getElementById(id);
    if(!el) return;
    if(document.activeElement === el) return;
    el.checked = !!value;
  }

  function msToMMSS(ms){
    ms = Math.max(0, ms|0);
    const t = Math.floor(ms/1000);
    const m = String(Math.floor(t/60)).padStart(2,'0');
    const s = String(t%60).padStart(2,'0');
    return `${m}:${s}`;
  }

  function render(){
    if(!state) return;

    safeSetValue("title", state.title || "");
    safeSetValue("nameA", state.teamA?.name || "");
    safeSetValue("nameB", state.teamB?.name || "");
    safeSetValue("logoA", state.teamA?.logo || "");
    safeSetValue("logoB", state.teamB?.logo || "");

    const colorA = document.getElementById("colorA");
    if(colorA && document.activeElement !== colorA) colorA.value = state.teamA?.color || "#1e88e5";
    const colorB = document.getElementById("colorB");
    if(colorB && document.activeElement !== colorB) colorB.value = state.teamB?.color || "#e53935";

    document.getElementById("scoreA").textContent = state.teamA?.score ?? 0;
    document.getElementById("scoreB").textContent = state.teamB?.score ?? 0;

    safeSetChecked("showPeriod", !!state.showPeriod);
    safeSetValue("periodLabel", state.periodLabel || "");
    safeSetChecked("showClock", !!state.showClock);

    const c = state.clock || {};
    document.getElementById("clockInfo").textContent =
      (c.running ? "⏱️ идёт" : "⏸️ пауза") + " | " + msToMMSS(c.baseMs||0);
  }

  // --- Действия

  function saveTitle(){
    sendPatch({ title: document.getElementById("title").value.trim() });
    setTimeout(pull, 600);
  }
  function quickTitle(t){
    document.getElementById("title").value = t;
    saveTitle();
  }

  function saveTeams(){
    sendPatch({
      teamA: {
        name: document.getElementById("nameA").value.trim(),
        color: document.getElementById("colorA").value,
        logo: document.getElementById("logoA").value.trim()
      },
      teamB: {
        name: document.getElementById("nameB").value.trim(),
        color: document.getElementById("colorB").value,
        logo: document.getElementById("logoB").value.trim()
      }
    });
    setTimeout(pull, 600);
  }

  function score(team, delta){
    if(!state) return pull();
    const key = team === "A" ? "teamA" : "teamB";
    const cur = state[key]?.score ?? 0;
    const next = Math.max(0, cur + delta);

    // ВАЖНО: меняем ТОЛЬКО счёт — чтобы не затирать названия!
    const patch = {};
    patch[key] = { score: next };
    sendPatch(patch);

    // локально обновим цифру
    state[key].score = next;
    render();
  }

  function setScore(team, value){
    if(!state) return pull();
    const key = team === "A" ? "teamA" : "teamB";
    const patch = {};
    patch[key] = { score: Math.max(0, value|0) };
    sendPatch(patch);
    state[key].score = Math.max(0, value|0);
    render();
  }

  function setLive(v){
    sendPatch({ live: !!v, status: v ? "LIVE" : "" });
    setTimeout(pull, 600);
  }

  function setBreak(){
    // статус + тайм "ПЕРЕРЫВ" + скрыть часы
    // если таймер шёл — останавливаем и фиксируем baseMs
    if(!state) return pull();
    const c = state.clock || {};
    const patch = {
      status: "ПЕРЕРЫВ",
      live: true,
      showClock: false,
      showPeriod: true,
      periodLabel: "ПЕРЕРЫВ"
    };
    if(c.running){
      const base = (c.baseMs||0) + (Date.now() - (c.startTs||Date.now()));
      patch.clock = { running:false, startTs:null, baseMs: base };
    }
    sendPatch(patch);
    setTimeout(pull, 600);
  }

  function clearStatus(){
    sendPatch({ status: "" });
    setTimeout(pull, 600);
  }

  function setPeriod(text){
    document.getElementById("periodLabel").value = text;
    document.getElementById("showPeriod").checked = true;
    savePeriod();
  }

  function savePeriod(){
    sendPatch({
      showPeriod: document.getElementById("showPeriod").checked,
      periodLabel: document.getElementById("periodLabel").value.trim()
    });
    setTimeout(pull, 600);
  }

  function setShowClock(v){
    document.getElementById("showClock").checked = !!v;
    sendPatch({ showClock: !!v });
    setTimeout(pull, 600);
  }

  function clockStart(){
    if(!state) return pull();
    const c = state.clock || {};
    if(c.running) return;
    sendPatch({ showClock:true, clock:{ running:true, startTs: Date.now() }, status:"LIVE", live:true });
    setTimeout(pull, 600);
  }

  function clockStop(){
    if(!state) return pull();
    const c = state.clock || {};
    if(!c.running) return;
    const base = (c.baseMs||0) + (Date.now() - (c.startTs||Date.now()));
    sendPatch({ clock:{ running:false, startTs:null, baseMs: base } });
    setTimeout(pull, 600);
  }

  function clockReset(){
    sendPatch({ clock:{ running:false, startTs:null, baseMs: 0 } });
    setTimeout(pull, 600);
  }

  // init
  (function init(){
    API = getApi();
    document.getElementById("api").value = API;
    setApiStatus(!!API);
    pull();
  })();
</script>

</body>
</html>